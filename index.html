<!-- 1) Config Uploadcare (doit venir AVANT le script de la lib) -->
<script>
  window.UPLOADCARE_PUBLIC_KEY = '21d7228fa1f01ac80183';
  window.UPLOADCARE_LOCALE_TRANSLATIONS = {
    buttons: { choose: { files: { one: 'Choisir un fichier…' } } }
  };
</script>

<!-- 2) Librairie Uploadcare -->
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

<!-- 3) Ton script — attend que la lib soit dispo puis initialise -->
<script>
(function () {
  const WEBHOOK_URL = 'https://vassili-jdel.app.n8n.cloud/webhook/auto-eval-memoire';

  function setStatus(msg, ok=false) {
    const el = document.getElementById('status');
    if (!el) return;
    el.textContent = msg;
    el.className = 'status ' + (ok ? 'ok' : 'err');
  }

  function initForm() {
    // La lib n’est pas encore chargée ? On réessaie un peu plus tard.
    if (typeof uploadcare === 'undefined') {
      console.log('[init] Uploadcare pas encore chargé, on réessaie…');
      return setTimeout(initForm, 300);
    }

    console.log('[init] Uploadcare OK');

    const form = document.getElementById('memoire-form');
    const submitBtn = document.getElementById('submitBtn');
    if (!form || !submitBtn) {
      console.warn('[init] Form non trouvé, on réessaie…');
      return setTimeout(initForm, 300);
    }

    // Crée le widget depuis ton input hidden
    const ucWidget = uploadcare.Widget('#file_url');

    // Log utile quand l’upload est fini
    ucWidget.onUploadComplete(info => {
      console.log('[uploadcare] done →', info?.cdnUrl, info?.name);
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('', true);
      console.log('[submit] démarré');

      // Validation minimale
      const requiredIds = ['prenom','nom','email','titre','langue','rgpd'];
      for (const id of requiredIds) {
        const el = document.getElementById(id);
        if (!el) continue;
        if (el.type === 'checkbox') {
          if (!el.checked) return setStatus('Veuillez accepter le traitement des données.');
        } else if (!el.value.trim()) {
          el.focus();
          return setStatus('Veuillez compléter tous les champs requis.');
        }
      }

      let fileVal = document.getElementById('file_url').value.trim();
      let fileName = 'memoire.docx';

      submitBtn.disabled = true;
      submitBtn.textContent = 'Téléversement… / Uploading…';

      try {
        const valObj = ucWidget.value();
        if (valObj) {
          // Cas nominal : on attend l’URL Uploadcare
          const info = await valObj.promise();     // { cdnUrl, name, ... }
          fileVal  = info.cdnUrl;
          fileName = info.name || fileName;
          console.log('[submit] URL depuis widget =', fileVal, 'filename =', fileName);
        } else if (fileVal) {
          // Repli : extraire l’UUID et reconstruire l’URL canonique si besoin
          const m = fileVal.match(/[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}/i);
          if (m) {
            fileVal = `https://ucarecdn.com/${m[0]}/`;
            console.log('[submit] URL canonique reconstruite =', fileVal);
          }
        } else {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Soumettre / Submit';
          return setStatus('Veuillez téléverser votre fichier.');
        }
      } catch (err) {
        console.error('[submit] Erreur Uploadcare', err);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Soumettre / Submit';
        return setStatus('Erreur Uploadcare : ' + (err?.message || err));
      }

      console.log('[submit] URL envoyée:', fileVal);

      // Envoi vers n8n
      submitBtn.textContent = 'Envoi… / Sending…';
      const payload = {
        prenom: document.getElementById('prenom').value.trim(),
        nom: document.getElementById('nom').value.trim(),
        email: document.getElementById('email').value.trim(),
        titre: document.getElementById('titre').value.trim(),
        langue: document.getElementById('langue').value,
        file_url: fileVal,
        file_name: fileName,
        rgpd: true,
        source: 'web-form'
      };

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          setStatus('Soumission envoyée. Merci !', true);
          // window.location.href = 'merci.html'; // réactive si tu veux rediriger
        } else {
          const text = await res.text();
          setStatus('Erreur de soumission : ' + text);
        }
      } catch (err) {
        setStatus('Erreur réseau : ' + (err?.message || err));
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Soumettre / Submit';
      }
    });

    console.log('[init] Form prêt ✅');
  }

  // Lance l’init (si la lib n’est pas prête, initForm va se reprogrammer tout seul)
  initForm();
})();
</script>
