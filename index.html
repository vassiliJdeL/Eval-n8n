<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Soumission du mémoire / Thesis Submission</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280;
      --border:#d1d5db; --primary:#4338ca; --radius:8px;
      --shadow:0 4px 6px rgba(0,0,0,.1);
    }
    * { box-sizing: border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--text); margin:0; padding:2rem;
    }
    form {
      background:var(--card); padding:2rem; border-radius:var(--radius);
      box-shadow:var(--shadow); max-width:720px; margin:0 auto;
    }
    h1 { font-size:1.6rem; margin:0 0 1rem; }
    label { display:block; margin-top:1rem; font-weight:600; }
    input, select {
      width:100%; padding:.6rem .75rem; margin-top:.35rem;
      border:1px solid var(--border); border-radius:var(--radius);
      font-size:1rem;
    }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    button {
      margin-top:1.5rem; background:var(--primary); color:#fff; border:none;
      padding:.9rem 1.4rem; border-radius:var(--radius); cursor:pointer; font-weight:700;
    }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .hint { margin-top:.6rem; font-size:.9rem; color:var(--muted); }
    .status { margin-top:1rem; font-size:.95rem; }
    .ok { color:#0a7a2f; }
    .err { color:#b00020; }
  </style>
</head>
<body>

<form id="memoire-form" novalidate>
  <h1>Soumission du mémoire / Thesis Submission</h1>

  <div class="row">
    <div>
      <label for="prenom">Prénom / Forename *</label>
      <input type="text" id="prenom" name="prenom" required autocomplete="given-name">
    </div>
    <div>
      <label for="nom">Nom / Surname *</label>
      <input type="text" id="nom" name="nom" required autocomplete="family-name">
    </div>
  </div>

  <label for="email">Email *</label>
  <input type="email" id="email" name="email" required autocomplete="email">

  <label for="titre">Titre du mémoire / Thesis title *</label>
  <input type="text" id="titre" name="titre" required>

  <label for="langue">Langue / Language *</label>
  <select id="langue" name="langue" required>
    <option value="">—</option>
    <option value="français">Français / French</option>
    <option value="anglais">Anglais / English</option>
  </select>

  <label for="file_url">Fichier du mémoire / Thesis File *</label>
  <!-- Uploadcare widget -->
  <input type="hidden"
         id="file_url"
         role="uploadcare-uploader"
         name="file_url"
         data-clearable
         data-multiple="false"
         data-locale="fr"
         data-tabs="file url gdrive dropbox" />

  <label for="rgpd" style="font-weight:400;">
    <input type="checkbox" id="rgpd" name="rgpd" required>
    J’accepte que mes données soient traitées dans le cadre de cette évaluation. / I consent to the processing of my data.
  </label>

  <button id="submitBtn" type="submit">Soumettre / Submit</button>
  <div class="hint" aria-live="polite">
    Tous les champs sont obligatoires. / All fields are required.
  </div>
  <div id="status" class="status" aria-live="polite"></div>
</form>

<script>
  // Uploadcare config (clé publique uniquement)
  window.UPLOADCARE_PUBLIC_KEY = '21d7228fa1f01ac80183';
  window.UPLOADCARE_LOCALE_TRANSLATIONS = {
    buttons: { choose: { files: { one: 'Choisir un fichier…' } } }
  };
</script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

<script>
(function () {
  const form = document.getElementById('memoire-form');
  const submitBtn = document.getElementById('submitBtn');
  const statusEl = document.getElementById('status');
  const ucWidget = uploadcare.Widget('#file_url');

  const WEBHOOK_URL = 'https://vassili-jdel.app.n8n.cloud/webhook/auto-eval-memoire';

  function setStatus(msg, ok=false) {
    statusEl.textContent = msg;
    statusEl.className = 'status ' + (ok ? 'ok' : 'err');
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    setStatus('', true);

    // Validation minimale
    const requiredIds = ['prenom','nom','email','titre','langue','rgpd'];
    for (const id of requiredIds) {
      const el = document.getElementById(id);
      if (!el) continue;
      if (el.type === 'checkbox') {
        if (!el.checked) return setStatus('Veuillez accepter le traitement des données / Please consent to data processing.');
      } else if (!el.value.trim()) {
        el.focus();
        return setStatus('Veuillez compléter tous les champs requis / Please fill all required fields.');
      }
    }

    let fileVal = document.getElementById('file_url').value;
    const valObj = ucWidget.value();
    if (!valObj && !fileVal) {
      return setStatus('Veuillez téléverser votre fichier / Please upload your file.');
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Téléversement… / Uploading…';

    try {
      if (valObj) {
        const info = await valObj.promise();
        const name = info.name || 'memoire.docx';
        fileVal = info.cdnUrl + '/-/inline/yes/' + name;
      }
    } catch (err) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Soumettre / Submit';
      return setStatus('Erreur Uploadcare : ' + (err?.message || err));
    }

    const payload = {
      prenom: document.getElementById('prenom').value.trim(),
      nom: document.getElementById('nom').value.trim(),
      email: document.getElementById('email').value.trim(),
      titre: document.getElementById('titre').value.trim(),
      langue: document.getElementById('langue').value,
      file_url: fileVal,  // ✅ renommé
      rgpd: true,
      source: 'web-form'
    };

    submitBtn.textContent = 'Envoi… / Sending…';

    try {
      const res = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        window.location.href = 'merci.html';
      } else {
        const text = await res.text();
        setStatus('Erreur de soumission : ' + text);
      }
    } catch (err) {
      setStatus('Erreur réseau : ' + (err?.message || err));
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Soumettre / Submit';
    }
  });
})();
</script>

</body>
</html>
