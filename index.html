<script>
(function () {
  const form = document.getElementById('memoire-form');
  const submitBtn = document.getElementById('submitBtn');
  const statusEl = document.getElementById('status');
  const ucWidget = uploadcare.Widget('#file_url');

  const WEBHOOK_URL = 'https://vassili-jdel.app.n8n.cloud/webhook/auto-eval-memoire';

  function setStatus(msg, ok=false) {
    statusEl.textContent = msg;
    statusEl.className = 'status ' + (ok ? 'ok' : 'err');
  }

  // üîé logs utiles
  ucWidget.onUploadComplete(info => {
    console.log('[Uploadcare] onUploadComplete ‚Üí', info?.cdnUrl, info?.name);
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    setStatus('', true);

    console.log('[submit] d√©marr√©');
    console.log('[submit] ucWidget.value() =', ucWidget.value());

    // Validation minimale
    const requiredIds = ['prenom','nom','email','titre','langue','rgpd'];
    for (const id of requiredIds) {
      const el = document.getElementById(id);
      if (!el) continue;
      if (el.type === 'checkbox') {
        if (!el.checked) return setStatus('Veuillez accepter le traitement des donn√©es / Please consent to data processing.');
      } else if (!el.value.trim()) {
        el.focus();
        return setStatus('Veuillez compl√©ter tous les champs requis / Please fill all required fields.');
      }
    }

    let fileVal = document.getElementById('file_url').value.trim(); // valeur brute du champ cach√©
    let fileName = 'memoire.docx';

    submitBtn.disabled = true;
    submitBtn.textContent = 'T√©l√©versement‚Ä¶ / Uploading‚Ä¶';

    try {
      const valObj = ucWidget.value();
      if (valObj) {
        // ‚úÖ chemin nominal : on attend la promesse du widget
        const info = await valObj.promise(); // { cdnUrl, name, ... }
        fileVal  = info.cdnUrl;              // URL brute Uploadcare
        fileName = info.name || fileName;
        console.log('[submit] URL depuis widget =', fileVal, 'filename =', fileName);
      } else if (fileVal) {
        // üîÅ repli s√ªr : on reconstruit l‚ÄôURL canonique √† partir du UUID si besoin
        console.log('[submit] pas de valObj, on utilise la valeur du champ cach√© =', fileVal);
        const m = fileVal.match(/[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}/i);
        if (m) {
          fileVal = `https://ucarecdn.com/${m[0]}/`;
          console.log('[submit] URL canonique reconstruite =', fileVal);
        }
      } else {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Soumettre / Submit';
        return setStatus('Veuillez t√©l√©verser votre fichier / Please upload your file.');
      }
    } catch (err) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Soumettre / Submit';
      console.error('[submit] Erreur Uploadcare', err);
      return setStatus('Erreur Uploadcare : ' + (err?.message || err));
    }

    // Payload pour n8n
    const payload = {
      prenom: document.getElementById('prenom').value.trim(),
      nom: document.getElementById('nom').value.trim(),
      email: document.getElementById('email').value.trim(),
      titre: document.getElementById('titre').value.trim(),
      langue: document.getElementById('langue').value,
      file_url: fileVal,     // ‚úÖ soit cdnUrl, soit URL canonique ¬´ https://ucarecdn.com/<UUID>/ ¬ª
      file_name: fileName,   // nom s√©par√©
      rgpd: true,
      source: 'web-form'
    };

    console.log('[submit] payload.file_url =', payload.file_url);

    submitBtn.textContent = 'Envoi‚Ä¶ / Sending‚Ä¶';

    try {
      const res = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        window.location.href = 'merci.html';
      } else {
        const text = await res.text();
        console.error('[submit] Erreur de soumission', text);
        setStatus('Erreur de soumission : ' + text);
      }
    } catch (err) {
      console.error('[submit] Erreur r√©seau', err);
      setStatus('Erreur r√©seau : ' + (err?.message || err));
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Soumettre / Submit';
    }
  });
})();
</script>
