<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Soumission du mémoire / Thesis Submission</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280;
      --border:#d1d5db; --primary:#4338ca; --radius:8px; --shadow:0 4px 6px rgba(0,0,0,.1); }
    * { box-sizing:border-box }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:2rem}
    form{background:var(--card);padding:2rem;border-radius:8px;box-shadow:var(--shadow);max-width:720px;margin:0 auto}
    h1{font-size:1.6rem;margin:0 0 1rem}
    label{display:block;margin-top:1rem;font-weight:600}
    input,select{width:100%;padding:.6rem .75rem;margin-top:.35rem;border:1px solid var(--border);border-radius:8px;font-size:1rem}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    button{margin-top:1.5rem;background:var(--primary);color:#fff;border:none;padding:.9rem 1.4rem;border-radius:8px;cursor:pointer;font-weight:700}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .hint{margin-top:.6rem;font-size:.9rem;color:var(--muted)}
    .status{margin-top:1rem;font-size:.95rem}
    .ok{color:#0a7a2f}.err{color:#b00020}
  </style>
</head>
<body>

<form id="memoire-form" novalidate>
  <h1>Soumission du mémoire / Thesis Submission</h1>

  <div class="row">
    <div>
      <label for="prenom">Prénom / Forename *</label>
      <input type="text" id="prenom" name="prenom" required autocomplete="given-name">
    </div>
    <div>
      <label for="nom">Nom / Surname *</label>
      <input type="text" id="nom" name="nom" required autocomplete="family-name">
    </div>
  </div>

  <label for="email">Email *</label>
  <input type="email" id="email" name="email" required autocomplete="email">

  <label for="titre">Titre du mémoire / Thesis title *</label>
  <input type="text" id="titre" name="titre" required>

  <label for="langue">Langue / Language *</label>
  <select id="langue" name="langue" required>
    <option value="">—</option>
    <option value="fr">Français / French</option>
    <option value="en">Anglais / English</option>
  </select>

  <label for="doc">Fichier du mémoire / Thesis File (.docx) *</label>
  <input id="doc" name="doc" type="file"
         accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" required />

  <label for="rgpd" style="font-weight:400;">
    <input type="checkbox" id="rgpd" name="rgpd" required>
    J’accepte que mes données soient traitées dans le cadre de cette évaluation. / I consent to the processing of my data.
  </label>

  <button id="submitBtn" type="submit">Soumettre / Submit</button>
  <div class="hint" aria-live="polite">Tous les champs sont obligatoires. / All fields are required.</div>
  <div id="status" class="status" aria-live="polite"></div>
</form>

<script>
(function () {
  const WEBHOOK_URL = 'https://vassili-jdel.app.n8n.cloud/webhook/auto-eval-memoire'; // ← à adapter si besoin
  const MAX_MB = 20;

  const $ = (id) => document.getElementById(id);
  const setStatus = (msg, ok=false) => {
    const el = $('status');
    el.textContent = msg || '';
    el.className = 'status ' + (ok ? 'ok' : 'err');
  };
  const makeRunId = () => 'run_' + Math.random().toString(36).slice(2) + '_' + Date.now().toString(36);

  function validate() {
    const req = ['prenom','nom','email','titre','langue','doc','rgpd'];
    for (const id of req) {
      const el = $(id);
      if (!el) continue;
      if (el.type === 'checkbox' && !el.checked) { setStatus('Veuillez accepter le traitement des données.'); return false; }
      if (el.type === 'file') {
        if (!el.files || !el.files[0]) { setStatus('Veuillez sélectionner un fichier .docx.'); return false; }
      } else if (!el.value.trim()) { el.focus(); setStatus('Veuillez compléter tous les champs.'); return false; }
    }
    const f = $('doc').files[0];
    if (!f.name.toLowerCase().endsWith('.docx')) { setStatus('Le fichier doit être en .docx.'); return false; }
    const mb = f.size/(1024*1024);
    if (mb > MAX_MB) { setStatus(`Le fichier dépasse ${MAX_MB} Mo (${mb.toFixed(1)} Mo).`); return false; }
    return true;
  }

  $('memoire-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    setStatus('');
    if (!validate()) return;

    const f = $('doc').files[0];
    const runId = makeRunId();
    const fd = new FormData();
    fd.append('prenom', $('prenom').value.trim());
    fd.append('nom', $('nom').value.trim());
    fd.append('email', $('email').value.trim());
    fd.append('titre', $('titre').value.trim());
    fd.append('langue', $('langue').value);
    fd.append('rgpd', 'true');
    fd.append('source', 'web-form');
    fd.append('runId', runId);
    fd.append('file_name', f.name);
    fd.append('doc', f, f.name); // ← clé binaire attendue côté n8n

    const btn = $('submitBtn');
    btn.disabled = true; btn.textContent = 'Envoi… / Sending…';

    try {
      const res = await fetch(WEBHOOK_URL, { method: 'POST', body: fd });
      if (res.ok) {
        setStatus('Soumission envoyée. Merci ! Redirection…', true);
        try { window.location.href = 'merci.html'; } catch (_) {}
      } else {
        const text = await res.text();
        setStatus(`Erreur de soumission (${res.status}) : ${text}`);
      }
    } catch (err) {
      setStatus('Erreur réseau : ' + (err?.message || err));
      console.error(err);
    } finally {
      btn.disabled = false; btn.textContent = 'Soumettre / Submit';
    }
  });
})();
</script>

</body>
</html>
